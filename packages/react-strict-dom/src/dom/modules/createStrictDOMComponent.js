/**
 * Copyright (c) Meta Platforms, Inc. and affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 *
 * @flow strict
 */

import type { CompiledStyles } from '@stylexjs/stylex/lib/StyleXTypes';
import type { ReactDOMStyleProps } from '../../types/renderer.web';
import type { StrictProps } from '../../types/StrictProps';

import * as React from 'react';
import * as stylex from '@stylexjs/stylex';
import { errorMsg } from '../../shared/logUtils';
import { isPropAllowed } from '../../shared/isPropAllowed';

// $FlowFixMe[unclear-type]
function validateStrictProps(props: any) {
  Object.keys(props).forEach((key) => {
    const isValid = isPropAllowed(key);
    if (!isValid) {
      errorMsg(`invalid prop "${key}"`);
      delete props[key];
    }
  });
}

export function createStrictDOMComponent<T, P: StrictProps>(
  TagName: string,
  defaultStyle: StrictProps['style']
): component(ref?: React.RefSetter<T>, ...P) {
  // NOTE: `debug-style` is not generated by `stylex.create`
  // so it needs a type-cast
  const debugStyle: CompiledStyles = {
    $$css: true,
    'debug::name': `html-${TagName}` as $FlowFixMe
  };

  const component: React.AbstractComponent<P, T> = React.forwardRef(
    function (props, forwardedRef) {
      /**
       * get host props
       */
      const { for: htmlFor, style, ...restProps } = props;
      const hostProps: { ...P, htmlFor?: string } = restProps;
      validateStrictProps(hostProps);

      if (htmlFor != null) {
        hostProps.htmlFor = htmlFor;
      }
      if (props.role != null) {
        // "presentation" synonym has wider browser support
        // $FlowFixMe
        hostProps.role = props.role === 'none' ? 'presentation' : props.role;
      }
      if (TagName === 'button') {
        hostProps.type = hostProps.type ? hostProps.type : 'button';
      } else if (TagName === 'input' || TagName === 'textarea') {
        hostProps.dir = hostProps.dir ? hostProps.dir : 'auto';
      }

      /**
       * get host style props
       */
      // Waiting on a diff so we can remove this indirection.
      const hostStyleProps: ReactDOMStyleProps = stylex.props([
        debugStyle,
        defaultStyle,
        style
      ]);

      /**
       * Construct tree
       *
       * Intentional flow error as we are asking for a more specific type
       * than React itself.
       */
      const element = (
        <TagName
          {...hostProps}
          {...hostStyleProps}
          ref={forwardedRef as $FlowFixMe}
        />
      );
      return element;
    }
  );

  component.displayName = `html.${TagName}`;
  return component;
}
